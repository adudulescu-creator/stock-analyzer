<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S&P 500 Stock Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4">
        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <div class="flex justify-between items-center flex-wrap gap-2">
                <div>
                    <h1 class="text-2xl font-bold flex items-center gap-2">
                        <span class="text-blue-600">üìä</span> S&P 500 Stock Analyzer
                    </h1>
                    <p class="text-sm text-slate-600" id="stockCount">Loading...</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="showMethodology()" class="flex items-center gap-2 bg-slate-600 text-white px-4 py-2 rounded hover:bg-slate-700">
                        ‚ÑπÔ∏è Info
                    </button>
                    <button onclick="refreshData()" id="refreshBtn" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        <span id="refreshIcon">üîÑ</span> Refresh
                    </button>
                </div>
            </div>
            <div id="lastUpdate" class="mt-2 text-xs text-slate-500"></div>
        </div>

        <div id="loadingState" class="bg-white rounded-lg shadow p-8 text-center">
            <div class="text-4xl mb-4">üîÑ</div>
            <div class="text-xl font-semibold">Loading stock data...</div>
        </div>

        <div id="errorState" class="bg-red-50 border-2 border-red-300 rounded-lg p-6 hidden">
            <div class="text-xl font-bold text-red-700 mb-2">‚ö†Ô∏è Error</div>
            <div id="errorMessage" class="text-sm text-red-600"></div>
            <button onclick="refreshData()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded">Try Again</button>
        </div>

        <div id="stocksContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden"></div>

        <div id="loadMoreContainer" class="text-center mt-6 hidden">
            <button onclick="loadMore()" id="loadMoreBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                Load More
            </button>
            <p class="text-sm text-slate-600 mt-2">
                Showing <span id="displayCount">0</span> of <span id="totalCount">0</span>
            </p>
        </div>
    </div>

    <div id="methodologyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 p-4">
        <div class="min-h-screen flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full p-6">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-bold">About This App</h2>
                    <button onclick="hideMethodology()" class="text-2xl">√ó</button>
                </div>
                <div class="text-sm space-y-3">
                    <p><strong>Data Source:</strong> Yahoo Finance API (15-min delay)</p>
                    <p><strong>Coverage:</strong> 20 major S&P 500 stocks</p>
                    <p><strong>Refresh:</strong> Click refresh to update prices</p>
                    <p class="text-red-600"><strong>Disclaimer:</strong> Not financial advice. For educational purposes only.</p>
                </div>
                <button onclick="hideMethodology()" class="w-full mt-4 bg-blue-600 text-white py-2 rounded">Close</button>
            </div>
        </div>
    </div>

    <script>
        const stocks = [
            { symbol: 'AAPL', name: 'Apple', sector: 'Technology', cap: 3500 },
            { symbol: 'MSFT', name: 'Microsoft', sector: 'Technology', cap: 3200 },
            { symbol: 'NVDA', name: 'NVIDIA', sector: 'Technology', cap: 2800 },
            { symbol: 'GOOGL', name: 'Alphabet', sector: 'Technology', cap: 2100 },
            { symbol: 'AMZN', name: 'Amazon', sector: 'Consumer', cap: 2000 },
            { symbol: 'META', name: 'Meta', sector: 'Technology', cap: 1400 },
            { symbol: 'TSLA', name: 'Tesla', sector: 'Consumer', cap: 1100 },
            { symbol: 'BRK.B', name: 'Berkshire', sector: 'Financials', cap: 1000 },
            { symbol: 'LLY', name: 'Eli Lilly', sector: 'Healthcare', cap: 900 },
            { symbol: 'AVGO', name: 'Broadcom', sector: 'Technology', cap: 780 },
            { symbol: 'V', name: 'Visa', sector: 'Financials', cap: 600 },
            { symbol: 'JPM', name: 'JPMorgan', sector: 'Financials', cap: 580 },
            { symbol: 'WMT', name: 'Walmart', sector: 'Consumer', cap: 570 },
            { symbol: 'UNH', name: 'UnitedHealth', sector: 'Healthcare', cap: 550 },
            { symbol: 'XOM', name: 'Exxon', sector: 'Energy', cap: 540 },
            { symbol: 'MA', name: 'Mastercard', sector: 'Financials', cap: 480 },
            { symbol: 'PG', name: 'P&G', sector: 'Consumer', cap: 400 },
            { symbol: 'JNJ', name: 'J&J', sector: 'Healthcare', cap: 390 },
            { symbol: 'HD', name: 'Home Depot', sector: 'Consumer', cap: 380 },
            { symbol: 'COST', name: 'Costco', sector: 'Consumer', cap: 370 }
        ];

        let stockData = [];
        let displayLimit = 9;

        async function fetchStockPrice(symbol) {
            // Try multiple methods to fetch stock data
            const methods = [
                // Method 1: Direct API call
                async () => {
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
                    const response = await fetch(url);
                    return await response.json();
                },
                // Method 2: CORS proxy
                async () => {
                    const proxy = 'https://api.allorigins.win/raw?url=';
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    return await response.json();
                },
                // Method 3: Alternative CORS proxy
                async () => {
                    const proxy = 'https://corsproxy.io/?';
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
                    const response = await fetch(proxy + encodeURIComponent(url));
                    return await response.json();
                }
            ];

            for (let i = 0; i < methods.length; i++) {
                try {
                    const data = await methods[i]();
                    
                    if (data.chart?.result?.[0]) {
                        const quote = data.chart.result[0].meta;
                        const price = quote.regularMarketPrice || 0;
                        const prev = quote.chartPreviousClose || quote.previousClose || price;
                        const change = price - prev;
                        const pct = (change / prev) * 100;
                        
                        return {
                            price: price.toFixed(2),
                            change: change.toFixed(2),
                            changePercent: pct.toFixed(2),
                            timestamp: new Date().toLocaleString()
                        };
                    }
                } catch (e) {
                    console.error(`Method ${i + 1} failed for ${symbol}:`, e);
                    if (i === methods.length - 1) {
                        // All methods failed
                        return {
                            price: '0.00',
                            change: '0.00',
                            changePercent: '0.00',
                            timestamp: new Date().toLocaleString(),
                            error: true
                        };
                    }
                }
            }
            
            return {
                price: '0.00',
                change: '0.00',
                changePercent: '0.00',
                timestamp: new Date().toLocaleString(),
                error: true
            };
        }

        function renderStockCard(stock) {
            const pd = stock.priceData;
            const isPositive = pd && parseFloat(pd.changePercent) >= 0;
            const changeColor = isPositive ? 'text-green-600' : 'text-red-600';
            const sign = isPositive ? '+' : '';
            
            return `
                <div class="bg-white rounded-lg shadow border-2 border-slate-200 p-4 hover:border-blue-300 transition">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="text-2xl font-bold">${stock.symbol}</div>
                            <div class="text-sm text-slate-600">${stock.name}</div>
                        </div>
                        <div class="text-xs bg-purple-100 px-2 py-1 rounded">${stock.sector}</div>
                    </div>
                    ${pd ? `
                        <div class="bg-blue-50 rounded p-3 border border-blue-200">
                            ${pd.error ? 
                                '<div class="text-sm text-red-600">Price unavailable</div>' : 
                                `
                                <div class="text-2xl font-bold">$${pd.price}</div>
                                <div class="text-sm font-semibold ${changeColor}">
                                    ${sign}$${pd.change} (${sign}${pd.changePercent}%)
                                </div>
                                <div class="text-xs text-slate-500 mt-1">${pd.timestamp}</div>
                                `
                            }
                        </div>
                    ` : '<div class="bg-yellow-50 p-2 rounded text-sm">Loading...</div>'}
                    <div class="text-sm text-slate-600 mt-2">Market Cap: $${stock.cap}B</div>
                </div>
            `;
        }

        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('stocksContainer').classList.add('hidden');
            document.getElementById('loadMoreContainer').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');

            try {
                const batch = stocks.slice(0, displayLimit);
                const promises = batch.map(async (s, i) => {
                    await new Promise(r => setTimeout(r, i * 300)); // Increased delay
                    const priceData = await fetchStockPrice(s.symbol);
                    return { ...s, priceData };
                });
                
                stockData = await Promise.all(promises);
                stockData = [...stockData, ...stocks.slice(displayLimit).map(s => ({ ...s, priceData: null }))];
                
                renderStocks();
                
                document.getElementById('stockCount').textContent = 
                    `${stocks.length} stocks ‚Ä¢ ${stockData.filter(s => s.priceData && !s.priceData.error).length} loaded`;
                document.getElementById('lastUpdate').textContent = 
                    `Updated: ${new Date().toLocaleString()}`;
            } catch (e) {
                document.getElementById('errorState').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = e.message;
            } finally {
                btn.disabled = false;
                document.getElementById('loadingState').classList.add('hidden');
            }
        }

        function renderStocks() {
            const container = document.getElementById('stocksContainer');
            container.innerHTML = stockData.slice(0, displayLimit).map(renderStockCard).join('');
            container.classList.remove('hidden');
            
            const loadMore = document.getElementById('loadMoreContainer');
            if (displayLimit < stocks.length) {
                loadMore.classList.remove('hidden');
                document.getElementById('displayCount').textContent = displayLimit;
                document.getElementById('totalCount').textContent = stocks.length;
            } else {
                loadMore.classList.add('hidden');
            }
        }

        async function loadMore() {
            const btn = document.getElementById('loadMoreBtn');
            btn.disabled = true;
            btn.textContent = 'Loading...';
            
            const oldLimit = displayLimit;
            displayLimit = Math.min(displayLimit + 9, stocks.length);
            
            const newBatch = stocks.slice(oldLimit, displayLimit);
            const promises = newBatch.map(async (s, i) => {
                await new Promise(r => setTimeout(r, i * 300)); // Increased delay
                const priceData = await fetchStockPrice(s.symbol);
                return { ...s, priceData };
            });
            
            const newData = await Promise.all(promises);
            newData.forEach((s, i) => {
                stockData[oldLimit + i] = s;
            });
            
            renderStocks();
            document.getElementById('stockCount').textContent = 
                `${stocks.length} stocks ‚Ä¢ ${stockData.filter(s => s.priceData && !s.priceData.error).length} loaded`;
            
            btn.disabled = false;
            btn.textContent = 'Load More';
        }

        function showMethodology() {
            document.getElementById('methodologyModal').classList.remove('hidden');
        }

        function hideMethodology() {
            document.getElementById('methodologyModal').classList.add('hidden');
        }

        window.addEventListener('DOMContentLoaded', refreshData);
    </script>
</body>
</html>
